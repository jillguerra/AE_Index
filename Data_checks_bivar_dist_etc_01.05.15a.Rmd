---
title: "Data checks"
author: "Jill Guerra"
date: "January 3, 2016"
output: 
  html_document:
    keep_md: true 
---

###Load packages 
```{r}
library(ggplot2)
library(car) 
library(dplyr)
suppressPackageStartupMessages(library(dplyr))
library(gridExtra) # for grid.arrange 
library("reshape2")
#install.packages("png")
library("png")
#install.packages("raster")
library("raster") # for arranging pngs 
#install.packages("moments")
library("moments") # for skew & kurtosis
library(knitr)
```

###Import file
```{r}
fulldf_aei<- read.csv("~/AEI_Index/Census_data_formatted_for_R_01.06.16.csv", quote = '"', sep = ",", na.strings = c(".",""), strip.white = TRUE) # load full dataset
```

###Reshape data 
```{r}
# this may be useful down the road but not using at the moment. 
aei_melted <- melt(fulldf_aei) # new dataframe with melted data 
aes_index_var <- c("nochem", "croprot", "covercrop", "apm", "noconvtill", "directplanting", "lowtill", "drip") # drop of just index variables 
aes_socecon_var <- c("lowincome", "offfarminc", "association", "credit", "regtech", "famlab")# group of just the social and economic variables 

aei_melted2 <- aei_melted %>% 
  filter(variable %in% aes_index_var) # new dataframe with just the index variables 

(ggplot(aei_melted2, aes(x = X, y = value, colour = variable)) +
  geom_point()) # graph works. But now I really know that this graph should be showing the fitted values not the points. 

# not sure how to use this because the x variable doesn't make sense 

```

###Checking distribution 
```{r}
# loop to look at the distributions for all variables. It currently works. Saves all individual graphs in png files 
nm <- names(fulldf_aei[,3:18]) # calls all the AEI variables 
for (i in seq_along(nm)) {
  plots <- ggplot(fulldf_aei, aes_string(x=nm[i])) +
    geom_histogram()
  ggsave(plots,filename=paste("dist",nm[i],".png",sep=""))
 
}

# rl = lapply(sprintf("dist",i,".png",sep=""), png::readPNG)
# gl = lapply(rl, grid::rasterGrob)
# do.call(gridExtra::grid.arrange, gl) 

#histograms
hist(fulldf_aei$nochem)
hist(fulldf_aei$usefert)
hist(fulldf_aei$orgcomp)
hist(fulldf_aei$nitchem)
hist(fulldf_aei$notnitchem)
hist(fulldf_aei$manure)
hist(fulldf_aei$Innoculents)
hist(fulldf_aei$croprot)
hist(fulldf_aei$covercrop)
hist(fulldf_aei$apm)
hist(fulldf_aei$noconvtill)
hist(fulldf_aei$directplanting)
hist(fulldf_aei$lowtill)
hist(fulldf_aei$drip)
hist(fulldf_aei$lowincome) 
hist(fulldf_aei$offfarminc)
hist(fulldf_aei$credit)
hist(fulldf_aei$associated)
hist(fulldf_aei$famlab)
hist(fulldf_aei$regtech)
```

###DATA CHECKING 
```{r, results="hide"}
# create dataframe without the first two columns because they aren't numbers 
df_onlynum <- fulldf_aei[,3:(ncol(fulldf_aei))] # drop the first two columns 

#skewness 
skew <- apply(df_onlynum, 2, skewness, na.rm=TRUE) # call correct df, 2 means looking at columsn (1 would indicate looking rows), skewness is the function applied, ignore NAs 

#kurtosis
kurt <- apply(df_onlynum, 2, kurtosis, na.rm=TRUE) # df, looking at columns, kurtosis is function, ignore NAs

#variance 
variance <- apply(df_onlynum, 2, var, na.rm=TRUE)# df, looking at columns, variance is function, ignore NAs

#standard deviations 
sd <- apply(df_onlynum, 2, sd, na.rm=TRUE)

#standard error of the mean 
sd <- apply(df_onlynum, 2, sd, na.rm=TRUE)

# coefficient of variation 
# CV <- function(mean, sd) {
#   (sd/mean)*100
# }


```


###Create table with values for data checks
```{r, }
#combine values lists into a dataframe 
data_checks <- cbind(kurt, skew, variance, sd) 
knitr::kable(data_checks)
data_checks
```

###Checking Bivariate relationships of index components 
```{r}

# NOCHEM
a1 <- ggplot(fulldf_aei, aes(nochem, croprot)) +
  geom_point()+
  stat_smooth() 
a2 <- ggplot(fulldf_aei, aes(nochem, covercrop)) +
  geom_point() +
  stat_smooth() 
a3 <- ggplot(fulldf_aei, aes(nochem, apm)) +
  geom_point() +
  stat_smooth() 
a4 <- ggplot(fulldf_aei, aes(nochem, noconvtill)) +
  geom_point() +
  stat_smooth() 
a5 <- ggplot(fulldf_aei, aes(nochem, directplanting)) +
  geom_point() +
  stat_smooth() 
a6 <- ggplot(fulldf_aei, aes(nochem, lowtill)) +
  geom_point() +
  stat_smooth() 
a7 <- ggplot(fulldf_aei, aes(nochem, soil)) +
  geom_point() +
  stat_smooth() 
a8 <- ggplot(fulldf_aei, aes(nochem, drip)) +
  geom_point() +
  stat_smooth()
a9 <- ggplot(fulldf_aei, aes(nochem, usefert)) +
  geom_point() +
  stat_smooth()
grid.arrange(a1,a2,a3,a4,a5,a6,a7,a8,a9, ncol=3)


# CROPROT
b1 <- ggplot(fulldf_aei, aes(croprot, covercrop)) +
  geom_point() +
  stat_smooth() 
b2 <- ggplot(fulldf_aei, aes(croprot, apm)) +
  geom_point() +
  stat_smooth() 
b3 <- ggplot(fulldf_aei, aes(croprot, noconvtill)) +
  geom_point() +
  stat_smooth() 
b4 <- ggplot(fulldf_aei, aes(croprot, directplanting)) +
  geom_point() +
  stat_smooth() 
b5 <- ggplot(fulldf_aei, aes(croprot, lowtill)) +
  geom_point() +
  stat_smooth()
b6 <- ggplot(fulldf_aei, aes(croprot, soil)) +
  geom_point() +
  stat_smooth()
b7 <- ggplot(fulldf_aei, aes(croprot, drip)) +
  geom_point() +
  stat_smooth()
b8 <- ggplot(fulldf_aei, aes(croprot, usefert)) +
  geom_point() +
  stat_smooth()
grid.arrange(b1,b2,b3,b4,b5,b6,b7,b8, ncol=3) # put all the graphs into one grid 

# COVERCROP
c1 <- ggplot(fulldf_aei, aes(covercrop, apm)) +
  geom_point() +
  stat_smooth() 
c2 <- ggplot(fulldf_aei, aes(covercrop, noconvtill)) +
  geom_point() +
  stat_smooth() 
c3 <- ggplot(fulldf_aei, aes(covercrop, directplanting)) +
  geom_point() +
  stat_smooth() 
c4 <- ggplot(fulldf_aei, aes(covercrop, lowtill)) +
  geom_point() +
  stat_smooth()
c5 <- ggplot(fulldf_aei, aes(covercrop, soil)) +
  geom_point() +
  stat_smooth()
c6 <- ggplot(fulldf_aei, aes(covercrop, drip)) +
  geom_point() +
  stat_smooth()
c7 <- ggplot(fulldf_aei, aes(covercrop, usefert)) +
  geom_point() +
  stat_smooth()
grid.arrange(c1,c2,c3,c4,c5,c6,c7, ncol=3) # put all the graphs into one grid 

# APM 
d1 <- ggplot(fulldf_aei, aes(apm, noconvtill)) +
  geom_point() +
  stat_smooth() 
d2 <- ggplot(fulldf_aei, aes(apm, directplanting)) +
  geom_point() +
  stat_smooth() 
d3 <- ggplot(fulldf_aei, aes(apm, lowtill)) +
  geom_point() +
  stat_smooth()
d4 <- ggplot(fulldf_aei, aes(apm, soil)) +
  geom_point() +
  stat_smooth()
d5 <- ggplot(fulldf_aei, aes(apm, drip)) +
  geom_point() +
  stat_smooth()
d6 <- ggplot(fulldf_aei, aes(apm, usefert)) +
  geom_point() +
  stat_smooth()
grid.arrange(d1,d2,d3,d4,d5,d6, ncol=3) # put all the graphs into one grid 

#skipped a few

#DRIP
e1 <- ggplot(fulldf_aei, aes(drip, noconvtill)) +
  geom_point() +
  stat_smooth() 
e2 <- ggplot(fulldf_aei, aes(drip, directplanting)) +
  geom_point() +
  stat_smooth() 
e3 <- ggplot(fulldf_aei, aes(drip, lowtill)) +
  geom_point() +
  stat_smooth()
e4 <- ggplot(fulldf_aei, aes(drip, soil)) +
  geom_point() +
  stat_smooth()
e5 <- ggplot(fulldf_aei, aes(drip, usefert)) +
  geom_point() +
  stat_smooth()
grid.arrange(e1,e2,e3,e4,e5, ncol=3)

```


####Results: 

- very clear relatioship between nochem and fertilizer. 
- some relationship  between fert and covercrop/croprot/apm


###Checking bivariate relationships of SOCECON variables 
```{r}
# CREDIT
z <- ggplot(fulldf_aei, aes(credit, associated)) +
  geom_point() +
  stat_smooth() 
z1 <- ggplot(fulldf_aei, aes(credit, famlab)) +
  geom_point() +
  stat_smooth()
z2 <- ggplot(fulldf_aei, aes(credit, lowincome)) +
  geom_point() +
  stat_smooth() 
z3 <- ggplot(fulldf_aei, aes(credit, offfarminc)) +
  geom_point() +
  stat_smooth() 

grid.arrange(z, z1, z2,z3, ncol=3)

# ASSOCIATED
y <- ggplot(fulldf_aei, aes(associated, famlab)) +
  geom_point() +
  stat_smooth()
y1 <- ggplot(fulldf_aei, aes(associated, lowincome)) +
  geom_point() +
  stat_smooth() 
y2 <- ggplot(fulldf_aei, aes(associated, offfarminc)) +
  geom_point() +
  stat_smooth() 

grid.arrange(y, y1, y2, ncol=3)

# FAMLAB
x <- ggplot(fulldf_aei, aes(famlab, lowincome)) +
  geom_point() +
  stat_smooth() 
x1 <- ggplot(fulldf_aei, aes(famlab, offfarminc)) +
  geom_point() +
  stat_smooth() 
grid.arrange(x, x1, ncol=2)

# lowincome & offfarm
(w <- ggplot(fulldf_aei, aes(lowincome, offfarminc)) +
  geom_point() +
  stat_smooth()) 
```

####Results

- credit and associated positively related 
- no other ones are related in any significant way. 

###Relationship between nochem and SOCECON variables 
```{r}
#NOCHEM & SE VARIABLES
n <- ggplot(fulldf_aei, aes(nochem, associated)) +
  geom_point() +
  stat_smooth() 
n1 <- ggplot(fulldf_aei, aes(nochem, famlab)) +
  geom_point() +
  stat_smooth()
n2 <- ggplot(fulldf_aei, aes(nochem, lowincome)) +
  geom_point() +
  stat_smooth() 
n3 <- ggplot(fulldf_aei, aes(nochem, offfarminc)) +
  geom_point() +
  stat_smooth() 
n4 <- ggplot(fulldf_aei, aes(nochem, credit)) +
  geom_point() +
  stat_smooth() 
grid.arrange(n, n1, n2,n3,n4, ncol=3)

```

####Results: 

- interesting negative relationship between associatedand credit and nochem. Seems to show that more associatedness and access to credit will actually lead to higher levels of agrichem useage. 

###Testing to get all on the same graph
```{r}
(ggplot(fulldf_aei, aes(x=X)) + 
  geom_line(aes(y=nochem, color="disp")) + 
  geom_line(aes(y=drip, color="hp")) + 
  geom_line(aes(y=lowtill, color="wt")))
###### issue right now is that the group aesthetic is off. Need to change stat_bin? 

```

###Checking for leverage and outliers 
```{r}


```

###Regression tests with NOCHEM
```{r}
#REGRESS NO CHEM
nochem_lm <- lm(nochem ~ offfarminc + credit + lowincome + famlab + regtech + associated, fulldf_aei, , , na.exclude) # regression testing on nochem 
#na.exclude included because otherwise I cannot add the fitted values into the dataframe because there are lost observations 
# the spaces are for two other arguments that can be specified. I don't know how else to just leave them as default. 

fulldf_aei_fit <- fulldf_aei %>% 
  mutate(nochemfit = fitted(nochem_lm)) # insert new column with the fitted values for nochem into a new dataframe that will hold the fitted values 

# plot with fitted values 
plot_nochemfit <- ggplot(fulldf_aei_fit, aes(x=associated, y = nochemfit)) +
  geom_point() +
  stat_smooth()

#plot with regular values 
plot_nochem <- ggplot(fulldf_aei, aes(associated, nochem)) +
   geom_point() +
   stat_smooth() 

grid.arrange(plot_nochemfit, plot_nochem, ncol = 2)

nochem_lm
```
##RESOURCES 


Visualizing distribution: 
https://flowingdata.com/2012/05/15/how-to-visualize-and-compare-distributions/

Creating a looping graph 
http://www.r-bloggers.com/ggplot2-graphics-in-a-loop/

Dealing with non-normal data 
http://www.isixsigma.com/tools-templates/normality/dealing-non-normal-data-strategies-and-tools/


